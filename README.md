# CW-Notify-Detector

Специализированный микросервис на базе **Telethon** и **Aiogram** для мониторинга игровых каналов ChatWars ([ChatWarsAuction](https://t.me/ChatWarsAuction) и [chatwars3](https://t.me/chatwars3)).

Основная задача приложения — обеспечить реал-тайм передачу данных об аукционах в централизованный канал [lot_updater](https://t.me/lot_updater) для последующей обработки другими ботами. Проект выделен из монолитного решения в отдельный контейнер для оптимизации ресурсов и повышения отказоустойчивости.

## Ключевые особенности

*   **Real-time мониторинг:** Использование протокола MTProto (через Telethon) исключает задержки, свойственные HTTP-поллингу.
*   **Облачная синхронизация:** Автоматическая загрузка файла сессии Telegram из Google Drive при старте.
*   **Форматирование:** Преобразование входящих постов (экранирование HTML, замена переносов) для стандартизации данных.
*   **Docker-интеграция:** Полная контейнеризация, встроенные Healthcheck-проверки и механизм экспоненциальной задержки (backoff) для предотвращения цикличных перезапусков.
*   **Система алертов:** Уведомление разработчика о критических ошибках или превышении лимитов логгирования через Telegram-бота.

## Принцип работы

1.  При запуске скрипт скачивает актуальную сессию из Google Drive.
2.  Подключается к API Telegram и подписывается на события `NewMessage` целевых каналов.
3.  При обнаружении нового поста текст форматируется и отправляется путем **редактирования** (edit) закрепленного сообщения на сервере-агрегаторе.
4.  Обновляется файл статуса (`tmp/healthy`) для мониторинга жизни контейнера.

## Change Log

`20.11.2025` Глобальное обновление стабильности. Переезд на Docker. Внедрен механизм экспоненциальной задержки (backoff) при аварийных перезапусках. Добавлен Docker Healthcheck. Оптимизирована система алертов (автоматическая отправка файлов при превышении лимита сообщения). Код реструктурирован: конфигурация и работа с GDrive вынесены в отдельные модули.

`18.10.2023` Переход на парсинг с помощью Telethon. Скрипт работает из файла main.py, detector.py сохранён для истории.

`28.11.2022` e-objects 1.2.0 перенесена в functions.py, чтобы не вызывать конфликтов на сервере.

`21.11.2020` Перенес переменные постов на канале [lot_updater](https://t.me/lot_updater) в окружение,
чтобы не выпускать патчи каждый раз когда эти посты нужно поменять.

`12.11.2020` Обновил библиотеку e-objects до версии 1.2.0.

